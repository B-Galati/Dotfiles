#!/bin/bash

if [ -z $PLEX_MEDIA_FOLDERS ]; then
    echo "Need to set PLEX_MEDIA_FOLDERS environment variable"
    exit 3
fi

CONTAINER_NAME="plex"
RUNNING=$(docker inspect --format="{{ .State.Running }}" $CONTAINER_NAME 2> /dev/null)

case "$1" in
    start)
        if [ "$RUNNING" == "true" ]; then
            echo "already running..."
            exit 2
        fi

        if [ "$RUNNING" == "false" ]; then
            echo "starting container..."
            docker start $CONTAINER_NAME
        else
            volumesArgs=''
            IFS=';'
            for path in $PLEX_MEDIA_FOLDERS; do
                volumesArgs+="-v $path:/data/$(basename $path) "
            done
            unset IFS

            echo "running container..."
            eval "docker run -it --name plex \\
                -h plex-benoit \\
                -v $HOME/.config/plex:/config \\
                $volumesArgs \\
                -p 32400:32400 \\
                timhaak/plex"
        fi
    ;;

    stop)
        echo "Stoping container..."
        docker stop $CONTAINER_NAME
    ;;

    rm)
        echo "Deleting container..."
        docker rm -v $CONTAINER_NAME
    ;;

    *)
        echo "Usage: $0 {start|stop|rm}"
        exit 1
    ;;
esac
